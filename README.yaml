name: "aws-dns-delegated"
# Canonical GitHub repo
github_repo: "cloudposse-terraform-components/aws-dns-delegated"
# Short description of this project
description: |
  This component provisions a delegated DNS zone for managing subdomains delegated from a primary DNS account.
  The primary DNS zone must already exist via the dns-primary component. Use dns-delegated when you need a
  subdomain (e.g. prod.example.com) managed in a different account from the primary root zone (e.g. example.com).

  If you are deploying a root zone (e.g. example.com) and only a single account needs to manage or update the
  zone, use the dns-primary component instead. See “Why not use dns-delegated for all vanity domains?” for details.

  This component also provisions a wildcard ACM certificate for the delegated subdomain. Deploy it globally (once per
  account) rather than regionally; see “Why should the dns-delegated component be deployed globally rather than
  regionally?” for rationale.

  Note: After delegating a subdomain (e.g. prod.example.com) to an account, that account can create deeper
  subdomains (e.g. api.use1.prod.example.com) without additional delegation, but additional TLS certificates may be
  required because a wildcard certificate only matches a single level. Use the acm component for additional certs.

  Limitations

  Switching a hosted zone from public to private can cause issues because the provider will try to perform an update
  instead of a ForceNew. It is not possible to toggle between public and private. If changing from public to private
  and downtime is acceptable, delete records and the hosted zone, destroy the Terraform component, and re-deploy with
  new settings.

  If downtime is acceptable (workaround):
  1. Delete anything using ACMs connected to previous hosted zones
  2. Delete ACMs
  3. Delete entries in the public hosted zone
  4. Delete the hosted zone
  5. Use atmos to destroy dns-delegated to remove the public hosted zone
  6. Use atmos to deploy dns-delegated for the private hosted zone
  7. Re-deploy dependent components (aurora-postgres, msk, external-dns, echo-server, etc.) to the new hosted zone

  If downtime is not acceptable (workaround):
  1. Create a new virtual component of dns-delegated with the correct private inputs
  2. Deploy the new dns-delegated-private component
  3. Re-deploy dependent components to the new hosted zone

  Caveats

  - Do not create an NS delegation for a subdomain within a zone that is not authoritative for that subdomain (e.g. if
    a parent subdomain is already delegated). Route 53 Public DNS allows conflicting delegations, which can cause
    inconsistent resolution depending on the resolver’s strategy (see RFC7816 “QName Minimization”). Verify proper
    resolution with multiple resolvers (e.g. 8.8.8.8 and 1.1.1.1).
usage: |
  Stack Level: Global

  Use this component in global stacks for any accounts where you host services that need DNS records on a delegated
  subdomain of the root domain.

  Public hosted zone example: devplatform.example.net is created and the example.net zone in the primary DNS account
  contains a record delegating DNS to the new hosted zone. This also creates an ACM record.

  ```yaml
  components:
    terraform:
      dns-delegated:
        vars:
          zone_config:
            - subdomain: devplatform
              zone_name: example.net
          request_acm_certificate: true
          dns_private_zone_enabled: false
          #  dns_soa_config configures the SOA record for the zone::
          #    - awsdns-hostmaster.amazon.com. ; AWS default value for administrator email address
          #    - 1 ; serial number, not used by AWS
          #    - 7200 ; refresh time in seconds for secondary DNS servers to refresh SOA record
          #    - 900 ; retry time in seconds for secondary DNS servers to retry failed SOA record update
          #    - 1209600 ; expire time in seconds (1209600 is 2 weeks) for secondary DNS servers to remove SOA record if they cannot refresh it
          #    - 60 ; nxdomain TTL, or time in seconds for secondary DNS servers to cache negative responses
          #    See SOA Record Documentation for more information.
          dns_soa_config: "awsdns-hostmaster.amazon.com. 1 7200 900 1209600 60"
  ```

  Private hosted zone example: devplatform.example.net is created and the example.net zone in the primary DNS account
  contains a record delegating DNS to the new hosted zone. This creates an ACM record using a Private CA.

  ```yaml
  components:
    terraform:
      dns-delegated:
        vars:
          zone_config:
            - subdomain: devplatform
              zone_name: example.net
          request_acm_certificate: true
          dns_private_zone_enabled: true
          vpc_region_abbreviation_type: short
          vpc_primary_environment_name: use2
          certificate_authority_component_name: private-ca-subordinate
          certificate_authority_stage_name: pca
          certificate_authority_environment_name: use2
          certificate_authority_component_key: subordinate
  ```
license: "APACHE2"
references:
  - name: dns-primary component
    description: ""
    url: https://github.com/cloudposse/terraform-aws-components/tree/main/modules/dns-primary
  - name: Why not use dns-delegated for all vanity domains?
    description: ""
    url: https://docs.cloudposse.com/layers/network/faq/#why-not-use-dns-delegated-for-all-vanity-domains
  - name: Why deploy dns-delegated globally rather than regionally?
    description: ""
    url: https://docs.cloudposse.com/layers/network/faq/#why-should-the-dns-delegated-component-be-deployed-globally-rather-than-regionally
  - name: acm component
    description: ""
    url: https://github.com/cloudposse/terraform-aws-components/tree/readme-global-only/modules/acm
  - name: Terraform AWS Provider Issue #7614
    description: ""
    url: https://github.com/hashicorp/terraform-provider-aws/issues/7614
  - name: SOA Record Documentation
    description: ""
    url: https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/SOA-NSrecords.html
  - name: RFC7816 QName Minimization
    description: ""
    url: https://tools.ietf.org/html/rfc7816
categories:
  - dns
  - route53
  - acm
  - certificates
  - networking
  - aws
tags: []
